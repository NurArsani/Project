#!/bin/bash

# Exit immediately on error
set -e

# Get the file name from the argument
FILENAME="$1"
BASENAME=$(basename "$FILENAME" .parquet)
OUTFILE="summary_${BASENAME}.csv"

# Set up Kaggle credentials
mkdir -p ~/.kaggle
cp kaggle.json ~/.kaggle/
chmod 600 ~/.kaggle/kaggle.json

# Download specific Parquet file from Kaggle
echo "Downloading $FILENAME from Kaggle..."
kaggle datasets download -d marcbrandner/tlc-trip-record-data-yellow-taxi --unzip -f "$FILENAME"

# Confirm download
if [ ! -f "$FILENAME" ]; then
  echo "Download failed for $FILENAME"
  exit 2
fi

echo "Processing $FILENAME..."

# Python: process and save summary as CSV
python3 - <<EOF

import pandas as pd
from datetime import datetime

# Load file
df = pd.read_parquet("$FILENAME")
df["tpep_pickup_datetime"] = pd.to_datetime(df["tpep_pickup_datetime"])
df["tpep_dropoff_datetime"] = pd.to_datetime(df["tpep_dropoff_datetime"])

# Derived fields
df["trip_duration_min"] = (df["tpep_dropoff_datetime"] - df["tpep_pickup_datetime"]).dt.total_seconds() / 60
df["rush_hour"] = df["tpep_pickup_datetime"].dt.hour.isin([7,8,9,16,17,18,19])
df["pickup_hour"] = df["tpep_pickup_datetime"].dt.hour
df["pickup_dayofweek"] = df["tpep_pickup_datetime"].dt.dayofweek
df["is_holiday"] = df["tpep_pickup_datetime"].dt.strftime('%Y-%m-%d').isin(["2009-01-01"])

# Flattened summary table (one-row CSV)
summary = pd.DataFrame([{
    "file": "$FILENAME",
    "n_rows": len(df),
    "rush_hour_avg_fare": df[df["rush_hour"]]["Fare_amount"].mean(),
    "non_rush_avg_fare": df[~df["rush_hour"]]["Fare_amount"].mean(),
    "holiday_trip_count": int(df["is_holiday"].sum()),
    "avg_trip_distance": df["Trip_distance"].mean(),
    "fare_vs_distance_corr": df["Fare_amount"].corr(df["Trip_distance"]),
    "airport_trip_count": int(df["RateCodeID"].isin([2,6]).sum()),
    "duration_vs_distance_corr": df["trip_duration_min"].corr(df["Trip_distance"]),
    "congestion_surcharge_total": df["Congestion_Surcharge"].sum(),
    "group_ride_count": int((df["RateCodeID"] == 6).sum()),
    "total_revenue": df["Total_amount"].sum(),
    "anomalous_fares_count": int((df["Fare_amount"] > 200).sum()),
    "rush_hour_extra_avg": df[df["rush_hour"]]["Extra"].mean()
}])

summary.to_csv("$OUTFILE", index=False)
EOF

echo "one. Saved summary to $OUTFILE"
